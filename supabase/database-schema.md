-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.agent_conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_key character varying NOT NULL UNIQUE,
  user_id character varying NOT NULL,
  channel_id character varying NOT NULL,
  channel_type character varying,
  current_plan text,
  metadata jsonb DEFAULT '{}'::jsonb,
  started_at timestamp with time zone DEFAULT now(),
  last_updated timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  is_active boolean DEFAULT true,
  CONSTRAINT agent_conversations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.agent_executions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid,
  execution_type character varying,
  status character varying,
  error_details jsonb,
  execution_time_ms integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT agent_executions_pkey PRIMARY KEY (id),
  CONSTRAINT agent_executions_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.agent_conversations(id)
);
CREATE TABLE public.agent_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid,
  role character varying NOT NULL CHECK (role::text = ANY (ARRAY['user'::character varying, 'assistant'::character varying, 'system'::character varying]::text[])),
  content text NOT NULL,
  message_metadata jsonb DEFAULT '{}'::jsonb,
  token_count integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT agent_messages_pkey PRIMARY KEY (id),
  CONSTRAINT agent_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.agent_conversations(id)
);
CREATE TABLE public.auth_account_lockouts (
  id bigint NOT NULL DEFAULT nextval('auth_account_lockouts_id_seq'::regclass),
  email text NOT NULL UNIQUE,
  locked_at timestamp with time zone NOT NULL DEFAULT now(),
  locked_until timestamp with time zone NOT NULL,
  failed_attempts integer NOT NULL DEFAULT 0,
  last_attempt_ip text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT auth_account_lockouts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.auth_login_attempts (
  id bigint NOT NULL DEFAULT nextval('auth_login_attempts_id_seq'::regclass),
  email text NOT NULL,
  ip_address text,
  attempt_time timestamp with time zone NOT NULL DEFAULT now(),
  success boolean NOT NULL DEFAULT false,
  user_agent text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT auth_login_attempts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.business_profiles (
  user_id character varying UNIQUE,
  company_name character varying NOT NULL,
  industry character varying,
  company_size character varying,
  website character varying,
  company_linkedin_url character varying,
  product_description text,
  value_proposition text,
  target_market text,
  pain_points_addressed ARRAY,
  key_differentiators ARRAY,
  pricing_model character varying,
  id integer NOT NULL DEFAULT nextval('business_profiles_id_seq'::regclass),
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  product_page_1 character varying,
  product_page_2 character varying,
  product_page_3 character varying,
  case_studies_url character varying,
  about_page_url character varying,
  additional_resource_url character varying,
  urls_collected_at timestamp without time zone,
  unique_selling_points text,
  CONSTRAINT business_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT business_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.communication_preferences (
  id integer NOT NULL DEFAULT nextval('communication_preferences_id_seq'::regclass),
  user_id character varying UNIQUE,
  communication_style character varying DEFAULT 'professional'::character varying CHECK (communication_style::text = ANY (ARRAY['professional'::character varying, 'casual'::character varying, 'consultative'::character varying]::text[])),
  message_length character varying DEFAULT 'medium'::character varying CHECK (message_length::text = ANY (ARRAY['short'::character varying::text, 'medium'::character varying::text, 'long'::character varying::text, 'brief'::character varying::text, 'moderate'::character varying::text, 'detailed'::character varying::text])),
  cta_preference character varying DEFAULT 'meeting'::character varying CHECK (cta_preference::text = ANY (ARRAY['meeting'::character varying::text, 'call'::character varying::text, 'email'::character varying::text, 'website'::character varying::text, 'soft'::character varying::text, 'custom'::character varying::text])),
  signature_style text DEFAULT 'Best regards'::text,
  avoid_phrases ARRAY,
  calendar_link character varying,
  personalization_elements jsonb,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  message_types jsonb,
  primary_style character varying,
  custom_cta text,
  CONSTRAINT communication_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT communication_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.company_profiles (
  id integer NOT NULL DEFAULT nextval('company_profiles_id_seq'::regclass),
  team_id character varying,
  company_name character varying NOT NULL,
  industry character varying,
  company_size character varying,
  website character varying,
  business_linkedin_url character varying,
  product_description text,
  key_benefits text,
  unique_selling_points text,
  target_market text,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  product_page_1 character varying,
  product_page_2 character varying,
  product_page_3 character varying,
  case_studies_url character varying,
  about_page_url character varying,
  additional_resource_url character varying,
  urls_collected_at timestamp without time zone,
  CONSTRAINT company_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT company_profiles_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id)
);
CREATE TABLE public.connection_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id character varying NOT NULL,
  recipient_linkedin_id text NOT NULL,
  message_text text,
  message_length integer,
  is_personalised boolean DEFAULT false,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'accepted'::text, 'ignored'::text, 'withdrawn'::text])),
  sent_at timestamp with time zone DEFAULT now(),
  status_changed_at timestamp with time zone,
  withdrawal_scheduled_for timestamp with time zone DEFAULT (now() + '14 days'::interval),
  auto_withdrawn boolean DEFAULT false,
  sequence_id bigint,
  prospect_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT connection_requests_pkey PRIMARY KEY (id),
  CONSTRAINT connection_requests_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT connection_requests_sequence_id_fkey FOREIGN KEY (sequence_id) REFERENCES public.outreach_sequences(id),
  CONSTRAINT connection_requests_prospect_id_fkey FOREIGN KEY (prospect_id) REFERENCES public.sequence_prospects(id)
);
CREATE TABLE public.deleted_accounts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email_hash text NOT NULL UNIQUE,
  original_user_id uuid NOT NULL,
  deleted_at timestamp with time zone NOT NULL DEFAULT now(),
  soft_delete_until timestamp with time zone NOT NULL DEFAULT (now() + '30 days'::interval),
  messages_sent_total integer DEFAULT 0,
  icps_created_total integer DEFAULT 0,
  knowledge_entries_total integer DEFAULT 0,
  prospects_created_total integer DEFAULT 0,
  deletion_reason text,
  created_at timestamp with time zone DEFAULT now(),
  hard_deleted boolean DEFAULT false,
  CONSTRAINT deleted_accounts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.error_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  workflow_id text,
  workflow_name text,
  run_id text,
  node_id text,
  node_name text,
  error_type text CHECK (error_type = ANY (ARRAY['postgres'::text, 'agent'::text, 'other'::text])),
  severity text DEFAULT 'medium'::text CHECK (severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  error_code text,
  error_message text,
  payload jsonb,
  CONSTRAINT error_events_pkey PRIMARY KEY (id)
);
CREATE TABLE public.icps (
  id integer NOT NULL DEFAULT nextval('icps_id_seq'::regclass),
  team_id character varying,
  icp_name character varying NOT NULL,
  description text,
  job_titles ARRAY,
  company_characteristics text,
  pain_points ARRAY,
  value_drivers ARRAY,
  industry_focus ARRAY,
  company_size_range character varying,
  is_active boolean DEFAULT true,
  created_by character varying,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  geographic_focus ARRAY,
  budget_range character varying,
  decision_making_process text,
  objections_and_concerns ARRAY,
  success_metrics ARRAY,
  sales_cycle_length character varying,
  preferred_communication_channels ARRAY,
  technology_stack ARRAY,
  competitive_alternatives ARRAY,
  product_link_id integer,
  workflow_status USER-DEFINED DEFAULT 'form'::icp_workflow_status,
  review_status text DEFAULT 'pending'::text,
  reviewed_at timestamp with time zone,
  reviewed_by character varying,
  review_notes text,
  metadata jsonb DEFAULT '{}'::jsonb,
  generation_attempts integer DEFAULT 0,
  last_error text,
  deleted_at timestamp with time zone,
  can_restore_until timestamp with time zone,
  buying_signals ARRAY,
  key_messaging_points ARRAY,
  call_to_action text,
  market_trends text,
  competitive_landscape text,
  growth_opportunities ARRAY,
  risk_factors ARRAY,
  last_used timestamp with time zone,
  CONSTRAINT icps_pkey PRIMARY KEY (id),
  CONSTRAINT icps_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id),
  CONSTRAINT icps_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id),
  CONSTRAINT icps_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.users(user_id),
  CONSTRAINT icps_product_link_id_fkey FOREIGN KEY (product_link_id) REFERENCES public.knowledge_base(id)
);
CREATE TABLE public.integrations (
  id integer NOT NULL DEFAULT nextval('integrations_id_seq'::regclass),
  team_id character varying,
  integration_type character varying CHECK (integration_type::text = ANY (ARRAY['unipile'::character varying, 'salesforce'::character varying, 'hubspot'::character varying, 'pipedrive'::character varying, 'calendar'::character varying]::text[])),
  config_data jsonb,
  is_active boolean DEFAULT true,
  last_sync_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT integrations_pkey PRIMARY KEY (id),
  CONSTRAINT integrations_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id)
);
CREATE TABLE public.interactive_message_tracking (
  id integer NOT NULL DEFAULT nextval('interactive_message_tracking_id_seq'::regclass),
  message_ts character varying NOT NULL,
  channel_id character varying NOT NULL,
  thread_ts character varying,
  user_id character varying NOT NULL,
  message_type character varying NOT NULL,
  message_context jsonb NOT NULL,
  expires_at timestamp without time zone NOT NULL,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT interactive_message_tracking_pkey PRIMARY KEY (id)
);
CREATE TABLE public.knowledge_base (
  id integer NOT NULL DEFAULT nextval('knowledge_base_id_seq'::regclass),
  team_id character varying,
  knowledge_type character varying CHECK (knowledge_type::text = ANY (ARRAY['product'::character varying::text, 'company'::character varying::text, 'case_study'::character varying::text, 'service'::character varying::text, 'pain_point'::character varying::text, 'objection'::character varying::text])),
  title character varying NOT NULL,
  content text NOT NULL,
  metadata jsonb,
  embedding USER-DEFINED,
  created_by character varying,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  deleted_at timestamp with time zone,
  can_restore_until timestamp with time zone,
  ai_generation_count integer DEFAULT 0,
  last_ai_generation timestamp with time zone,
  workflow_status character varying DEFAULT 'active'::character varying,
  workflow_metadata jsonb,
  last_enhanced_at timestamp with time zone,
  review_status character varying,
  review_notes text,
  reviewed_by uuid,
  reviewed_at timestamp with time zone,
  summary text,
  CONSTRAINT knowledge_base_pkey PRIMARY KEY (id),
  CONSTRAINT knowledge_base_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES auth.users(id),
  CONSTRAINT knowledge_base_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id),
  CONSTRAINT knowledge_base_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.knowledge_base_ai_usage (
  id integer NOT NULL DEFAULT nextval('knowledge_base_ai_usage_id_seq'::regclass),
  user_id character varying NOT NULL,
  knowledge_base_id integer,
  generation_type character varying,
  tokens_used integer,
  cost_estimate numeric,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT knowledge_base_ai_usage_pkey PRIMARY KEY (id),
  CONSTRAINT knowledge_base_ai_usage_knowledge_base_id_fkey FOREIGN KEY (knowledge_base_id) REFERENCES public.knowledge_base(id)
);
CREATE TABLE public.knowledge_base_edits (
  id integer NOT NULL DEFAULT nextval('knowledge_base_edits_id_seq'::regclass),
  user_id character varying NOT NULL,
  knowledge_base_id integer NOT NULL,
  edit_type character varying NOT NULL CHECK (edit_type::text = ANY (ARRAY['create'::character varying, 'update'::character varying, 'delete'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT knowledge_base_edits_pkey PRIMARY KEY (id),
  CONSTRAINT knowledge_base_edits_knowledge_base_id_fkey FOREIGN KEY (knowledge_base_id) REFERENCES public.knowledge_base(id)
);
CREATE TABLE public.knowledge_base_lifecycle (
  id integer NOT NULL DEFAULT nextval('knowledge_base_lifecycle_id_seq'::regclass),
  user_id character varying NOT NULL,
  entry_type character varying NOT NULL,
  action character varying NOT NULL,
  entry_data jsonb,
  knowledge_base_id integer,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT knowledge_base_lifecycle_pkey PRIMARY KEY (id)
);
CREATE TABLE public.knowledge_base_wiki (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  team_id character varying UNIQUE,
  title text NOT NULL,
  summary text,
  compiled_content text NOT NULL,
  table_of_contents jsonb,
  entry_ids ARRAY NOT NULL DEFAULT ARRAY[]::integer[],
  entry_count integer DEFAULT 0,
  last_entry_added integer,
  wiki_metadata jsonb DEFAULT '{}'::jsonb,
  ai_insights jsonb,
  status character varying DEFAULT 'building'::character varying CHECK (status::text = ANY (ARRAY['building'::character varying, 'ready'::character varying, 'updating'::character varying]::text[])),
  completeness_score integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  last_compiled_at timestamp with time zone,
  CONSTRAINT knowledge_base_wiki_pkey PRIMARY KEY (id),
  CONSTRAINT knowledge_base_wiki_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT knowledge_base_wiki_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id)
);
CREATE TABLE public.landing_interest (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  source text DEFAULT 'coldai.uk'::text,
  ip_address text,
  user_agent text,
  referrer text,
  processed boolean DEFAULT false,
  CONSTRAINT landing_interest_pkey PRIMARY KEY (id)
);
CREATE TABLE public.linkedin_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id character varying NOT NULL UNIQUE,
  account_type text NOT NULL DEFAULT 'free'::text CHECK (account_type = ANY (ARRAY['free'::text, 'premium'::text, 'sales_navigator'::text, 'recruiter_lite'::text, 'recruiter_pro'::text])),
  ssi_score integer DEFAULT 0 CHECK (ssi_score >= 0 AND ssi_score <= 100),
  inmail_credits_remaining integer DEFAULT 0,
  inmail_credits_max integer DEFAULT 0,
  inmail_renewal_date timestamp with time zone,
  connection_acceptance_rate numeric DEFAULT 0.50,
  message_response_rate numeric DEFAULT 0.10,
  account_status text DEFAULT 'active'::text CHECK (account_status = ANY (ARRAY['active'::text, 'warning'::text, 'restricted'::text, 'suspended'::text])),
  last_restriction_date timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT linkedin_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT linkedin_accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.message_generation_logs (
  id integer NOT NULL DEFAULT nextval('message_generation_logs_id_seq'::regclass),
  message_id character varying DEFAULT (gen_random_uuid())::text UNIQUE,
  user_id character varying,
  team_id character varying,
  generated_message text,
  edited_message text,
  message_status character varying DEFAULT 'generated'::character varying CHECK (message_status::text = ANY (ARRAY['analysing_icp'::character varying::text, 'analysing_prospect'::character varying::text, 'generating_message'::character varying::text, 'generated'::character varying::text, 'approved'::character varying::text, 'pending_scheduled'::character varying::text, 'scheduled'::character varying::text, 'sent'::character varying::text, 'failed'::character varying::text, 'archived'::character varying::text, 'researching_product'::character varying::text, 'analysing_conversation'::character varying::text])),
  ai_model_used character varying,
  generation_cost numeric,
  sent_at timestamp with time zone,
  response_received_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  research_cache_id integer,
  ai_context jsonb NOT NULL DEFAULT '{}'::jsonb,
  parent_message_id character varying,
  conversation_thread_id character varying DEFAULT (gen_random_uuid())::text,
  response_id integer,
  message_metadata jsonb,
  message_type text CHECK (message_type = ANY (ARRAY['direct_message'::text, 'connection_request'::text, 'connection_request_200'::text, 'connection_request_300'::text, 'first_message'::text, 'inmail'::text, 'open_profile'::text, 'group_message'::text, 'event_message'::text])),
  recipient_linkedin_id text,
  recipient_name text,
  subject_line text,
  message_length integer,
  is_personalised boolean DEFAULT false,
  unipile_message_id text,
  unipile_thread_id text,
  inmail_credit_consumed boolean DEFAULT false,
  inmail_credit_refunded boolean DEFAULT false,
  sequence_id bigint,
  sequence_message_id bigint,
  focus_analysis jsonb,
  focus_generated_at timestamp with time zone,
  sequence_prospect_id bigint,
  CONSTRAINT message_generation_logs_pkey PRIMARY KEY (id),
  CONSTRAINT message_generation_logs_research_cache_id_fkey FOREIGN KEY (research_cache_id) REFERENCES public.research_cache(id),
  CONSTRAINT message_generation_logs_parent_message_id_fkey FOREIGN KEY (parent_message_id) REFERENCES public.message_generation_logs(message_id),
  CONSTRAINT message_generation_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT message_generation_logs_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id),
  CONSTRAINT message_generation_logs_sequence_prospect_id_fkey FOREIGN KEY (sequence_prospect_id) REFERENCES public.sequence_prospects(id),
  CONSTRAINT message_generation_logs_sequence_id_fkey FOREIGN KEY (sequence_id) REFERENCES public.outreach_sequences(id),
  CONSTRAINT message_generation_logs_sequence_message_id_fkey FOREIGN KEY (sequence_message_id) REFERENCES public.sequence_messages(id)
);
CREATE TABLE public.message_quotas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id character varying NOT NULL UNIQUE,
  daily_direct_messages integer DEFAULT 0,
  daily_connection_requests integer DEFAULT 0,
  daily_inmails integer DEFAULT 0,
  daily_open_profile integer DEFAULT 0,
  daily_group_messages integer DEFAULT 0,
  daily_total_actions integer DEFAULT 0,
  daily_reset_at timestamp with time zone DEFAULT (date_trunc('day'::text, now()) + '1 day'::interval),
  weekly_connection_requests integer DEFAULT 0,
  weekly_first_action_at timestamp with time zone,
  weekly_reset_at timestamp with time zone,
  monthly_personalised_connections integer DEFAULT 0,
  monthly_open_profile_messages integer DEFAULT 0,
  monthly_reset_at timestamp with time zone DEFAULT (date_trunc('month'::text, now()) + '1 mon'::interval),
  pending_connections integer DEFAULT 0,
  pending_inmails integer DEFAULT 0,
  last_action_at timestamp with time zone,
  hourly_action_count integer DEFAULT 0,
  hourly_reset_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT message_quotas_pkey PRIMARY KEY (id),
  CONSTRAINT message_quotas_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.message_templates (
  id integer NOT NULL DEFAULT nextval('message_templates_id_seq'::regclass),
  team_id character varying,
  template_name character varying NOT NULL,
  channel character varying CHECK (channel::text = ANY (ARRAY['linkedin'::character varying, 'email'::character varying, 'call_script'::character varying]::text[])),
  template_content text NOT NULL,
  personalization_tokens jsonb,
  performance_metrics jsonb DEFAULT '{"sent": 0, "responded": 0, "meetings_booked": 0}'::jsonb,
  a_b_test_variant character varying,
  is_active boolean DEFAULT true,
  created_by character varying,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT message_templates_pkey PRIMARY KEY (id),
  CONSTRAINT message_templates_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id),
  CONSTRAINT message_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.outreach_sequences (
  id bigint NOT NULL DEFAULT nextval('outreach_sequences_id_seq'::regclass),
  user_id character varying NOT NULL,
  team_id character varying,
  sequence_name text NOT NULL,
  sequence_type text NOT NULL CHECK (sequence_type = ANY (ARRAY['connection_request'::text, 'inmail'::text, 'message'::text])),
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'active'::text, 'paused'::text, 'completed'::text, 'archived'::text])),
  icp_id bigint,
  target_search_query text,
  target_filters jsonb DEFAULT '{}'::jsonb,
  message_template text NOT NULL,
  follow_up_messages jsonb DEFAULT '[]'::jsonb,
  daily_limit integer NOT NULL DEFAULT 50 CHECK (daily_limit <= 100),
  delay_between_min integer NOT NULL DEFAULT 5,
  delay_between_max integer NOT NULL DEFAULT 15,
  working_hours_only boolean DEFAULT true,
  working_days ARRAY DEFAULT ARRAY[1, 2, 3, 4, 5],
  timezone text DEFAULT 'UTC'::text,
  total_targets integer DEFAULT 0,
  sent_count integer DEFAULT 0,
  accepted_count integer DEFAULT 0,
  replied_count integer DEFAULT 0,
  failed_count integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  CONSTRAINT outreach_sequences_pkey PRIMARY KEY (id),
  CONSTRAINT outreach_sequences_icp_id_fkey FOREIGN KEY (icp_id) REFERENCES public.icps(id),
  CONSTRAINT outreach_sequences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT outreach_sequences_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id)
);
CREATE TABLE public.product_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  team_id text,
  name text NOT NULL,
  url text NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'researching'::text, 'completed'::text, 'error'::text])),
  research_data jsonb,
  last_researched timestamp with time zone,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_links_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_profiles (
  id integer NOT NULL DEFAULT nextval('product_profiles_id_seq'::regclass),
  user_id character varying UNIQUE,
  products jsonb DEFAULT '[]'::jsonb,
  features ARRAY,
  benefits ARRAY,
  use_cases ARRAY,
  integrations ARRAY,
  pricing_tiers jsonb,
  demo_link character varying,
  documentation_link character varying,
  case_study_links ARRAY,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT product_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.product_research_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_link_id uuid NOT NULL,
  status text DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'processing'::text, 'completed'::text, 'failed'::text])),
  webhook_response jsonb,
  attempts integer DEFAULT 0,
  error_message text,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  processed_at timestamp with time zone,
  CONSTRAINT product_research_queue_pkey PRIMARY KEY (id),
  CONSTRAINT product_research_queue_product_link_id_fkey FOREIGN KEY (product_link_id) REFERENCES public.product_links(id)
);
CREATE TABLE public.quota_violations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id character varying NOT NULL,
  violation_type text NOT NULL,
  limit_value integer,
  actual_value integer,
  message text,
  occurred_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quota_violations_pkey PRIMARY KEY (id),
  CONSTRAINT quota_violations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.research_cache (
  id integer NOT NULL DEFAULT nextval('research_cache_id_seq'::regclass),
  profile_url character varying,
  profile_type character varying CHECK (profile_type::text = ANY (ARRAY['personal_user'::character varying::text, 'personal_prospect'::character varying::text, 'company_user'::character varying::text, 'company_prospect'::character varying::text])),
  research_data jsonb,
  research_depth character varying CHECK (research_depth::text = ANY (ARRAY['basic'::character varying, 'standard'::character varying, 'deep'::character varying]::text[])),
  last_researched_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  research_version integer DEFAULT 1,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  profile_picture_url text,
  deleted_at timestamp with time zone,
  CONSTRAINT research_cache_pkey PRIMARY KEY (id)
);
CREATE TABLE public.sequence_messages (
  id bigint NOT NULL DEFAULT nextval('sequence_messages_id_seq'::regclass),
  sequence_id bigint NOT NULL,
  prospect_id bigint NOT NULL,
  user_id character varying NOT NULL,
  message_text text NOT NULL,
  message_type text NOT NULL CHECK (message_type = ANY (ARRAY['connection_request'::text, 'inmail'::text, 'message'::text, 'follow_up'::text])),
  step_number integer NOT NULL DEFAULT 0,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sending'::text, 'sent'::text, 'failed'::text])),
  unipile_chat_id text,
  unipile_message_id text,
  scheduled_for timestamp with time zone,
  sent_at timestamp with time zone,
  error_message text,
  retry_count integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT sequence_messages_pkey PRIMARY KEY (id),
  CONSTRAINT sequence_messages_sequence_id_fkey FOREIGN KEY (sequence_id) REFERENCES public.outreach_sequences(id),
  CONSTRAINT sequence_messages_prospect_id_fkey FOREIGN KEY (prospect_id) REFERENCES public.sequence_prospects(id),
  CONSTRAINT sequence_messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.sequence_prospects (
  id bigint NOT NULL DEFAULT nextval('sequence_prospects_id_seq'::regclass),
  sequence_id bigint NOT NULL,
  user_id character varying NOT NULL,
  linkedin_url text NOT NULL,
  linkedin_public_id text NOT NULL,
  linkedin_messaging_id text,
  prospect_name text,
  prospect_headline text,
  prospect_company text,
  prospect_data jsonb DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'pending_scheduled'::text, 'searching'::text, 'scheduled'::text, 'sending'::text, 'sent'::text, 'accepted'::text, 'replied'::text, 'failed'::text, 'skipped'::text])),
  scheduled_for timestamp with time zone,
  sent_at timestamp with time zone,
  last_message_at timestamp with time zone,
  current_step integer DEFAULT 0,
  connection_accepted boolean DEFAULT false,
  response_received boolean DEFAULT false,
  unipile_chat_id text,
  error_message text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  message_log_id bigint,
  CONSTRAINT sequence_prospects_pkey PRIMARY KEY (id),
  CONSTRAINT sequence_prospects_sequence_id_fkey FOREIGN KEY (sequence_id) REFERENCES public.outreach_sequences(id),
  CONSTRAINT sequence_prospects_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT sequence_prospects_message_log_id_fkey FOREIGN KEY (message_log_id) REFERENCES public.message_generation_logs(id)
);
CREATE TABLE public.subscriptions (
  subscription_id character varying NOT NULL,
  squarespace_subscription_id character varying UNIQUE,
  billing_email character varying NOT NULL UNIQUE,
  plan_type character varying NOT NULL CHECK (plan_type::text = ANY (ARRAY['free'::character varying, 'basic'::character varying, 'standard'::character varying, 'pro'::character varying, 'team_basic'::character varying, 'team_xl'::character varying]::text[])),
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'trialing'::character varying, 'past_due'::character varying, 'cancelled'::character varying, 'expired'::character varying]::text[])),
  billing_cycle_start date,
  billing_cycle_end date,
  max_teams_allowed integer DEFAULT 1,
  teams_created integer DEFAULT 0,
  stripe_customer_id character varying,
  stripe_subscription_id character varying,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  user_id character varying,
  CONSTRAINT subscriptions_pkey PRIMARY KEY (subscription_id),
  CONSTRAINT subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.sync_status (
  sync_type character varying NOT NULL,
  last_check_timestamp timestamp with time zone,
  last_order_id character varying,
  orders_processed integer DEFAULT 0,
  last_error text,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT sync_status_pkey PRIMARY KEY (sync_type)
);
CREATE TABLE public.team_memberships (
  id integer NOT NULL DEFAULT nextval('team_memberships_id_seq'::regclass),
  team_id character varying,
  user_id character varying,
  role character varying DEFAULT 'member'::character varying CHECK (role::text = ANY (ARRAY['manager'::character varying, 'member'::character varying]::text[])),
  can_manage_icps boolean DEFAULT false,
  can_manage_company_profile boolean DEFAULT false,
  can_view_team_stats boolean DEFAULT true,
  can_invite_members boolean DEFAULT false,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'invited'::character varying]::text[])),
  invited_by character varying,
  joined_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  can_manage_knowledge_base boolean DEFAULT false,
  CONSTRAINT team_memberships_pkey PRIMARY KEY (id),
  CONSTRAINT team_memberships_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id),
  CONSTRAINT team_memberships_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT team_memberships_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.teams (
  team_id character varying NOT NULL DEFAULT (gen_random_uuid())::text,
  team_name character varying NOT NULL,
  subscription_id character varying,
  product_focus character varying,
  monthly_message_limit integer NOT NULL,
  monthly_messages_used integer DEFAULT 0,
  reset_date date DEFAULT CURRENT_DATE,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'suspended'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT teams_pkey PRIMARY KEY (team_id),
  CONSTRAINT teams_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(subscription_id)
);
CREATE TABLE public.usage_tracking (
  id integer NOT NULL DEFAULT nextval('usage_tracking_id_seq'::regclass),
  user_id character varying,
  team_id character varying,
  usage_date date DEFAULT CURRENT_DATE,
  messages_generated integer DEFAULT 0,
  messages_sent integer DEFAULT 0,
  messages_archived integer DEFAULT 0,
  research_performed integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  connection_requests_sent integer DEFAULT 0,
  CONSTRAINT usage_tracking_pkey PRIMARY KEY (id),
  CONSTRAINT usage_tracking_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT usage_tracking_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(team_id)
);
CREATE TABLE public.user_profiles (
  id integer NOT NULL DEFAULT nextval('user_profiles_id_seq'::regclass),
  user_id character varying UNIQUE,
  linkedin_url character varying,
  linkedin_connected boolean DEFAULT false,
  unipile_account_id character varying,
  user_role character varying,
  territory character varying,
  personal_bio text,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  job_title character varying,
  phone_number character varying,
  linkedin_profile_data jsonb,
  linkedin_profile_updated_at timestamp with time zone,
  linkedin_profile_scraped_at timestamp with time zone,
  linkedin_profile_hash character varying,
  linkedin_premium boolean,
  url_list text,
  linkedin_public_identifier text,
  linkedin_connection_history jsonb DEFAULT '[]'::jsonb,
  linkedin_connection_error text,
  account_status text DEFAULT 'active'::text CHECK (account_status = ANY (ARRAY['active'::text, 'pending_deletion'::text, 'deleted'::text])),
  deletion_requested_at timestamp with time zone,
  CONSTRAINT user_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT user_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.user_prospect_relationships (
  id integer NOT NULL DEFAULT nextval('user_prospect_relationships_id_seq'::regclass),
  user_id uuid NOT NULL,
  research_cache_id integer NOT NULL,
  network_distance text,
  connection_status text,
  messages_generated integer DEFAULT 0,
  last_message_at timestamp with time zone,
  last_checked_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT user_prospect_relationships_pkey PRIMARY KEY (id),
  CONSTRAINT user_prospect_relationships_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_prospect_relationships_research_cache_id_fkey FOREIGN KEY (research_cache_id) REFERENCES public.research_cache(id)
);
CREATE TABLE public.user_sessions (
  id integer NOT NULL DEFAULT nextval('user_sessions_id_seq'::regclass),
  user_id character varying,
  session_token character varying DEFAULT (gen_random_uuid())::text UNIQUE,
  slack_channel_id character varying,
  slack_thread_ts character varying,
  slack_user_id character varying,
  auth_message_ts character varying,
  auth_status character varying DEFAULT 'pending'::character varying,
  auth_initiated_at timestamp with time zone,
  awaiting_callback boolean DEFAULT false,
  session_active boolean DEFAULT true,
  expires_at timestamp with time zone DEFAULT (CURRENT_TIMESTAMP + '01:00:00'::interval),
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  channel_type character varying DEFAULT 'channel'::character varying,
  is_dm boolean DEFAULT false,
  CONSTRAINT user_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.users (
  user_id character varying NOT NULL,
  email character varying UNIQUE,
  first_name character varying,
  last_name character varying,
  slack_team_id character varying,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'suspended'::character varying]::text[])),
  onboarding_completed boolean DEFAULT false,
  onboarding_step integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  onboarding_completed_at timestamp without time zone,
  onboarding_urls_collected boolean DEFAULT false,
  profile_analyzed boolean DEFAULT false,
  analysis_completed_at timestamp without time zone,
  ready_for_outreach boolean DEFAULT false,
  profile_completion jsonb DEFAULT '{"company": false, "product": false, "personal": false, "percentage": 0, "communication": false}'::jsonb,
  email_verified boolean DEFAULT false,
  terms_accepted_at timestamp with time zone,
  terms_version text DEFAULT '2024-10-16'::text,
  privacy_accepted_at timestamp with time zone,
  privacy_version text DEFAULT '2024-10-16'::text,
  CONSTRAINT users_pkey PRIMARY KEY (user_id)
);
CREATE TABLE public.webhook_events (
  id integer NOT NULL DEFAULT nextval('webhook_events_id_seq'::regclass),
  user_id text,
  event_type text,
  source text DEFAULT 'other'::text CHECK (source = ANY (ARRAY['knowledge_base'::text, 'icp'::text, 'message'::text, 'other'::text])),
  status text DEFAULT 'processing'::text,
  payload jsonb,
  result jsonb,
  error_message text,
  processed boolean DEFAULT false,
  retry_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  completed_at timestamp with time zone,
  updated_at timestamp with time zone,
  idempotency_key text,
  CONSTRAINT webhook_events_pkey PRIMARY KEY (id),
  CONSTRAINT webhook_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);